# LiveKit AgentServer Architecture Diagram - Food Concierge Voice

## Overview

This document explains how the **LiveKit AgentServer framework** powers the Food Court Concierge voice experience. It covers the complete flow from voice input to voice output, showing how LiveKit, Python agents, OpenAI, and Supabase work together for real-time voice interactions.

**Target Audience**: Beginner to Intermediate developers
**Implementation**: 
- Python Agent: `/agents/food_concierge_agentserver.py`
- Database Layer: `/agents/database.py`
- Token Endpoint: `/app/api/livekit-agentserver/token`
- Frontend: `/app/food/concierge-agentserver`

---

## High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   User Voice     â”‚  (Speaks into microphone)
â”‚  React Frontend  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ WebRTC Audio Stream
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LiveKit Cloud Infrastructure                           â”‚
â”‚  - WebRTC Media Server                                  â”‚
â”‚  - Room Management                                      â”‚
â”‚  - Agent Dispatch System                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ RTC Session
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Python AgentServer                                     â”‚
â”‚  food_concierge_agentserver.py                          â”‚
â”‚                                                         â”‚
â”‚  STT (Deepgram) â†’ LLM (OpenAI) â†’ TTS (OpenAI)          â”‚
â”‚  + Function Tools (9 tools)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â–º OpenAI API (GPT-4o-mini)
         â”‚        â””â”€â–º Function calling for tools
         â”‚
         â””â”€â”€â”€â”€â”€â”€â–º database.py â†’ Supabase
                  â””â”€â–º Query food data
```

---

## Core Components

### 1. Connection Flow

```
User clicks "Start Voice"
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend: POST /api/livekit-agentserver/   â”‚
â”‚            token                            â”‚
â”‚                                             â”‚
â”‚  Request: {                                 â”‚
â”‚    roomName: "food-concierge-agentserver-   â”‚
â”‚               {timestamp}",                 â”‚
â”‚    participantName: "user-{random}"         â”‚
â”‚  }                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Token Endpoint                             â”‚
â”‚  /app/api/livekit-agentserver/token/        â”‚
â”‚  route.ts                                   â”‚
â”‚                                             â”‚
â”‚  1. Create room in LiveKit                  â”‚
â”‚  2. Dispatch agent: "ubereats-food-         â”‚
â”‚     concierge"                              â”‚
â”‚  3. Generate access token                   â”‚
â”‚  4. Return to frontend                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend Connects                          â”‚
â”‚  @livekit/components-react                  â”‚
â”‚                                             â”‚
â”‚  â€¢ LiveKitRoom component                    â”‚
â”‚  â€¢ Connects with token                      â”‚
â”‚  â€¢ Publishes microphone audio               â”‚
â”‚  â€¢ Subscribes to agent audio                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Python Agent Auto-Joins                    â”‚
â”‚  @server.rtc_session decorator              â”‚
â”‚                                             â”‚
â”‚  â€¢ Agent dispatched by LiveKit              â”‚
â”‚  â€¢ Joins same room                          â”‚
â”‚  â€¢ Starts STT/LLM/TTS pipeline              â”‚
â”‚  â€¢ Sends greeting via TTS                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Voice Conversation Begins                  â”‚
â”‚  Real-time WebRTC bidirectional audio       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## AgentServer Pattern

### Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LiveKit AgentServer (Python)                              â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•               â”‚
â”‚                                                            â”‚
â”‚  @server.rtc_session decorator                             â”‚
â”‚  â””â”€â–º Handles room join events automatically                â”‚
â”‚                                                            â”‚
â”‚  AgentSession[UserState]                                   â”‚
â”‚  â”œâ”€â–º STT: inference.STT("deepgram/nova-3")                 â”‚
â”‚  â”œâ”€â–º LLM: inference.LLM("openai/gpt-4o-mini")              â”‚
â”‚  â”œâ”€â–º TTS: openai.TTS()                                     â”‚
â”‚  â”œâ”€â–º VAD: silero.VAD.load()                                â”‚
â”‚  â””â”€â–º Tools: 9 function_tool decorators                     â”‚
â”‚                                                            â”‚
â”‚  UserState (typed context)                                 â”‚
â”‚  â”œâ”€â–º user_id                                               â”‚
â”‚  â”œâ”€â–º cart_id                                               â”‚
â”‚  â”œâ”€â–º profile                                               â”‚
â”‚  â””â”€â–º local_participant (for data channel)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Key Differences from AI SDK

| Aspect | AI SDK (Chat) | LiveKit (Voice) |
|--------|---------------|-----------------|
| **Transport** | HTTP/POST | WebRTC |
| **Input** | Text messages | Audio stream |
| **Output** | Text stream | Audio stream |
| **Model Access** | Direct OpenAI API | Via LiveKit inference layer |
| **Tool Definition** | `tool()` from `ai` | `@function_tool` decorator |
| **State Management** | Message history | UserState dataclass |
| **Runtime** | Node.js/Edge | Python |
| **Real-time** | Streaming text | Streaming audio |

---

## Voice Conversation Flow - Complete Pipeline

```
User speaks: "Show me Thai restaurants"
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. AUDIO CAPTURE                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Frontend (Browser)                                      â”‚
â”‚  â€¢ Microphone captures audio                             â”‚
â”‚  â€¢ WebRTC encodes audio stream                           â”‚
â”‚  â€¢ Sends to LiveKit Cloud via WebRTC                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. SPEECH-TO-TEXT (STT)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Python Agent: AgentSession                              â”‚
â”‚                                                          â”‚
â”‚  STT: inference.STT("deepgram/nova-3")                   â”‚
â”‚  â€¢ Receives audio chunks from LiveKit                    â”‚
â”‚  â€¢ Sends to Deepgram Nova-3 model                        â”‚
â”‚  â€¢ Returns transcription                                 â”‚
â”‚                                                          â”‚
â”‚  Output: "Show me Thai restaurants"                      â”‚
â”‚                                                          â”‚
â”‚  Event: user_speech_committed                            â”‚
â”‚  â””â”€â–º Logged and sent to frontend                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. LANGUAGE MODEL (LLM)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Python Agent: AgentSession                              â”‚
â”‚                                                          â”‚
â”‚  LLM: inference.LLM("openai/gpt-4o-mini")                â”‚
â”‚  â€¢ Receives transcript from STT                          â”‚
â”‚  â€¢ Analyzes with system instructions                     â”‚
â”‚  â€¢ Decides action: text OR function call                 â”‚
â”‚                                                          â”‚
â”‚  System Instructions:                                    â”‚
â”‚  "You are the Food Concierge Assistant..."               â”‚
â”‚                                                          â”‚
â”‚  Available Functions (9 tools):                          â”‚
â”‚  - get_user_profile                                      â”‚
â”‚  - find_food_item                                        â”‚
â”‚  - find_restaurants_by_type                              â”‚
â”‚  - get_restaurant_menu                                   â”‚
â”‚  - fetch_menu_item_image                                 â”‚
â”‚  - quick_view_cart                                       â”‚
â”‚  - quick_add_to_cart                                     â”‚
â”‚  - remove_from_cart                                      â”‚
â”‚  - update_cart_quantity                                  â”‚
â”‚  - quick_checkout                                        â”‚
â”‚                                                          â”‚
â”‚  Decision: Call find_restaurants_by_type                 â”‚
â”‚  Parameters: { cuisine_type: "Thai" }                    â”‚
â”‚                                                          â”‚
â”‚  Event: function_calls_collected                         â”‚
â”‚  â””â”€â–º Logged to terminal                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. FUNCTION TOOL EXECUTION                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Python Agent: FoodConciergeAgent                        â”‚
â”‚                                                          â”‚
â”‚  @function_tool                                          â”‚
â”‚  async def find_restaurants_by_type_tool(               â”‚
â”‚      ctx: RunContext[UserState],                         â”‚
â”‚      cuisine_type: str                                   â”‚
â”‚  ) -> str:                                               â”‚
â”‚                                                          â”‚
â”‚  1. Log: "ğŸ”§ Tool: find_restaurants_by_type(            â”‚
â”‚           cuisine_type='Thai')"                          â”‚
â”‚                                                          â”‚
â”‚  2. Call database layer:                                 â”‚
â”‚     results = await search_restaurants_by_cuisine(       â”‚
â”‚         "Thai", 3                                        â”‚
â”‚     )                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. DATABASE QUERY                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  database.py: search_restaurants_by_cuisine()            â”‚
â”‚                                                          â”‚
â”‚  Supabase Query:                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚
â”‚  supabase.table("fc_restaurants")                        â”‚
â”‚    .select(                                              â”‚
â”‚       "id, slug, name, cuisine, rating,                  â”‚
â”‚        eta_minutes, delivery_fee, ..."                   â”‚
â”‚    )                                                     â”‚
â”‚    .eq("is_active", True)                                â”‚
â”‚    .or_(                                                 â”‚
â”‚       "cuisine.ilike.%Thai%,                             â”‚
â”‚        cuisine_group.ilike.%Thai%,                       â”‚
â”‚        name.ilike.%Thai%"                                â”‚
â”‚    )                                                     â”‚
â”‚    .order("name")                                        â”‚
â”‚    .limit(5)                                             â”‚
â”‚    .execute()                                            â”‚
â”‚                                                          â”‚
â”‚  Returns: [                                              â”‚
â”‚    {                                                     â”‚
â”‚      id: "uuid",                                         â”‚
â”‚      name: "Bangkok Express",                            â”‚
â”‚      cuisine: "Thai",                                    â”‚
â”‚      rating: 4.5,                                        â”‚
â”‚      etaMinutes: 25,                                     â”‚
â”‚      deliveryFee: 2.99                                   â”‚
â”‚    },                                                    â”‚
â”‚    ...                                                   â”‚
â”‚  ]                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. SEND DATA TO FRONTEND                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Python Agent Tool                                       â”‚
â”‚                                                          â”‚
â”‚  if ctx.userdata.local_participant:                      â”‚
â”‚      tool_data = {                                       â”‚
â”‚          "type": "tool_call",                            â”‚
â”‚          "tool_name": "find_restaurants_by_type",        â”‚
â”‚          "result": {                                     â”‚
â”‚              "restaurants": results,                     â”‚
â”‚              "cuisine": "Thai"                           â”‚
â”‚          }                                               â”‚
â”‚      }                                                   â”‚
â”‚      await ctx.userdata.local_participant.publish_data(  â”‚
â”‚          json.dumps(tool_data).encode(),                 â”‚
â”‚          reliable=True                                   â”‚
â”‚      )                                                   â”‚
â”‚                                                          â”‚
â”‚  Purpose: Send structured data for card rendering        â”‚
â”‚  â””â”€â–º Frontend displays restaurant cards                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. TOOL RETURNS TEXT SUMMARY                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Python Agent Tool                                       â”‚
â”‚                                                          â”‚
â”‚  response_parts = [                                      â”‚
â”‚      f"Found {len(results)} Thai restaurants:",          â”‚
â”‚      "1. Bangkok Express - Rating: 4.5",                 â”‚
â”‚      "2. Thai Orchid - Rating: 4.7",                     â”‚
â”‚      "3. Spicy Basil - Rating: 4.3"                      â”‚
â”‚  ]                                                       â”‚
â”‚  return "\n".join(response_parts)                        â”‚
â”‚                                                          â”‚
â”‚  Event: function_calls_finished                          â”‚
â”‚  â””â”€â–º Tool result logged                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  8. LLM GENERATES NATURAL RESPONSE                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Python Agent: AgentSession LLM                          â”‚
â”‚                                                          â”‚
â”‚  Input: Tool result text                                 â”‚
â”‚  Processing: Convert to natural language                 â”‚
â”‚                                                          â”‚
â”‚  Output: "I found 3 great Thai restaurants for you:     â”‚
â”‚           Bangkok Express has a 4.5 rating and can       â”‚
â”‚           deliver in 25 minutes. Thai Orchid is rated    â”‚
â”‚           4.7 stars. And Spicy Basil is 4.3 stars.       â”‚
â”‚           Which one sounds good?"                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  9. TEXT-TO-SPEECH (TTS)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Python Agent: AgentSession                              â”‚
â”‚                                                          â”‚
â”‚  TTS: openai.TTS()                                       â”‚
â”‚  â€¢ Receives text from LLM                                â”‚
â”‚  â€¢ Sends to OpenAI TTS API                               â”‚
â”‚  â€¢ Returns audio stream                                  â”‚
â”‚                                                          â”‚
â”‚  Event: agent_speech_committed                           â”‚
â”‚  â””â”€â–º Text logged and sent to frontend                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  10. AUDIO PLAYBACK                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  LiveKit Cloud â†’ Frontend                                â”‚
â”‚                                                          â”‚
â”‚  â€¢ Agent publishes audio track                           â”‚
â”‚  â€¢ LiveKit streams via WebRTC                            â”‚
â”‚  â€¢ Frontend's <AudioTrack> plays audio                   â”‚
â”‚  â€¢ User hears: "I found 3 great Thai restaurants..."     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CONVERSATION CONTINUES...                               â”‚
â”‚  User can respond immediately (full duplex)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Detailed Action Flows

## Action 1: Search Restaurants (Voice)

```
User says: "Show me Thai restaurants"
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STT: Deepgram Nova-3                                    â”‚
â”‚  Transcribes: "Show me Thai restaurants"                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLM: OpenAI GPT-4o-mini                                 â”‚
â”‚                                                          â”‚
â”‚  Analyzes intent: User wants restaurant search           â”‚
â”‚  Selected tool: find_restaurants_by_type                 â”‚
â”‚  Extracted params: { cuisine_type: "Thai" }              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tool Execution: find_restaurants_by_type_tool()         â”‚
â”‚                                                          â”‚
â”‚  async def find_restaurants_by_type_tool(                â”‚
â”‚      ctx: RunContext[UserState],                         â”‚
â”‚      cuisine_type: "Thai"                                â”‚
â”‚  ):                                                      â”‚
â”‚      max_results = 3  # hardcoded                        â”‚
â”‚      results = await search_restaurants_by_cuisine(      â”‚
â”‚          "Thai", 3                                       â”‚
â”‚      )                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Database Query (database.py)                            â”‚
â”‚                                                          â”‚
â”‚  async def search_restaurants_by_cuisine(                â”‚
â”‚      cuisine_type: str,                                  â”‚
â”‚      max_results: int                                    â”‚
â”‚  ):                                                      â”‚
â”‚      response = supabase                                 â”‚
â”‚          .table("fc_restaurants")                        â”‚
â”‚          .select("*")                                    â”‚
â”‚          .eq("is_active", True)                          â”‚
â”‚          .or_(                                           â”‚
â”‚              "cuisine.ilike.%Thai%,"                     â”‚
â”‚              "cuisine_group.ilike.%Thai%,"               â”‚
â”‚              "name.ilike.%Thai%"                         â”‚
â”‚          )                                               â”‚
â”‚          .order("name")                                  â”‚
â”‚          .limit(5)                                       â”‚
â”‚          .execute()                                      â”‚
â”‚                                                          â”‚
â”‚      # Ensure images from Pexels if missing              â”‚
â”‚      for each restaurant:                                â”‚
â”‚          if not hero_image:                              â”‚
â”‚              hero_image = await fetch_image_from_pexels( â”‚
â”‚                  restaurant_name + " food restaurant"    â”‚
â”‚              )                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Data Channel to Frontend                                â”‚
â”‚                                                          â”‚
â”‚  await local_participant.publish_data(                   â”‚
â”‚      json.dumps({                                        â”‚
â”‚          "type": "tool_call",                            â”‚
â”‚          "tool_name": "find_restaurants_by_type",        â”‚
â”‚          "result": {                                     â”‚
â”‚              "restaurants": [                            â”‚
â”‚                  {                                       â”‚
â”‚                      "id": "uuid",                       â”‚
â”‚                      "name": "Bangkok Express",          â”‚
â”‚                      "cuisine": "Thai",                  â”‚
â”‚                      "rating": 4.5,                      â”‚
â”‚                      "etaMinutes": 25,                   â”‚
â”‚                      "heroImage": "https://..."          â”‚
â”‚                  },                                      â”‚
â”‚                  ...                                     â”‚
â”‚              ],                                          â”‚
â”‚              "cuisine": "Thai"                           â”‚
â”‚          }                                               â”‚
â”‚      }).encode(),                                        â”‚
â”‚      reliable=True                                       â”‚
â”‚  )                                                       â”‚
â”‚                                                          â”‚
â”‚  Purpose: Frontend renders restaurant cards              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tool Returns Text                                       â”‚
â”‚                                                          â”‚
â”‚  return """Found 3 Thai restaurants:                     â”‚
â”‚  1. Bangkok Express - Rating: 4.5                        â”‚
â”‚  2. Thai Orchid - Rating: 4.7                            â”‚
â”‚  3. Spicy Basil - Rating: 4.3"""                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLM Generates Response                                  â”‚
â”‚                                                          â”‚
â”‚  "I found 3 great Thai restaurants for you. Bangkok      â”‚
â”‚   Express has a 4.5 star rating and can deliver in       â”‚
â”‚   25 minutes. Thai Orchid is highly rated at 4.7.        â”‚
â”‚   And Spicy Basil has 4.3 stars. Which one would         â”‚
â”‚   you like to explore?"                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TTS: OpenAI TTS                                         â”‚
â”‚  Converts text to audio stream                           â”‚
â”‚  User hears the response                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Tables**: `fc_restaurants`
**External APIs**: Pexels (for images)
**Data Channel**: Restaurant cards sent to frontend

---

## Action 2: Search Menu Items (Voice)

```
User says: "Find me some cheesecake"
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STT â†’ LLM â†’ Tool Selection                              â”‚
â”‚                                                          â”‚
â”‚  Tool: find_food_item                                    â”‚
â”‚  Params: { query: "cheesecake" }                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Database Query (database.py)                            â”‚
â”‚                                                          â”‚
â”‚  async def search_menu_items(query, max_results):        â”‚
â”‚      # Multi-word search enhancement                     â”‚
â”‚      words = query.strip().split()                       â”‚
â”‚      # "New York cheesecake" â†’ ["New", "York",           â”‚
â”‚      #  "cheesecake"]                                    â”‚
â”‚                                                          â”‚
â”‚      # Build OR conditions for each word                 â”‚
â”‚      for word in words:                                  â”‚
â”‚          if len(word) >= 3:                              â”‚
â”‚              filters.append(                             â”‚
â”‚                  f"name.ilike.%{word}%,"                 â”‚
â”‚                  f"description.ilike.%{word}%"           â”‚
â”‚              )                                           â”‚
â”‚                                                          â”‚
â”‚      response = supabase                                 â”‚
â”‚          .table("fc_menu_items")                         â”‚
â”‚          .select("""                                     â”‚
â”‚              id, slug, name, description,                â”‚
â”‚              base_price, tags, calories, image,          â”‚
â”‚              section:section_id(id, name),               â”‚
â”‚              restaurant:restaurant_id(id, slug, name)    â”‚
â”‚          """)                                            â”‚
â”‚          .eq("is_available", True)                       â”‚
â”‚          .or_(/* multi-word OR conditions */)            â”‚
â”‚          .order("name")                                  â”‚
â”‚          .limit(max_results * 5)                         â”‚
â”‚          .execute()                                      â”‚
â”‚                                                          â”‚
â”‚      # Rank results by word match count                  â”‚
â”‚      def score_item(item):                               â”‚
â”‚          text = f"{item['name']} {item['description']}"  â”‚
â”‚          return sum(1 for word in words                  â”‚
â”‚                     if word.lower() in text.lower())     â”‚
â”‚                                                          â”‚
â”‚      results.sort(key=score_item, reverse=True)          â”‚
â”‚                                                          â”‚
â”‚      # Fetch images from Pexels if missing               â”‚
â”‚      for item in results:                                â”‚
â”‚          if not item.get("image"):                       â”‚
â”‚              item["image"] = await ensure_menu_item_     â”‚
â”‚                  image(item_id, item_slug, item_name,    â”‚
â”‚                         restaurant_name)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Returns: [                                              â”‚
â”‚      {                                                   â”‚
â”‚          "id": "item-123",                               â”‚
â”‚          "name": "Classic New York Cheesecake",          â”‚
â”‚          "price": 8.99,                                  â”‚
â”‚          "description": "Creamy cheesecake...",          â”‚
â”‚          "restaurantName": "Dessert Palace",             â”‚
â”‚          "restaurantSlug": "dessert-palace",             â”‚
â”‚          "image": "https://images.pexels.com/..."        â”‚
â”‚      },                                                  â”‚
â”‚      {                                                   â”‚
â”‚          "name": "Tropical Cheesecake",                  â”‚
â”‚          "price": 9.99,                                  â”‚
â”‚          "restaurantName": "Island Breeze",              â”‚
â”‚          ...                                             â”‚
â”‚      }                                                   â”‚
â”‚  ]                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Data Channel: Send results to frontend                  â”‚
â”‚  Frontend displays menu item cards with images           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Voice Response                                          â”‚
â”‚                                                          â”‚
â”‚  "I found 2 cheesecake options:                          â”‚
â”‚   1. Classic New York Cheesecake from Dessert Palace     â”‚
â”‚      for $8.99                                           â”‚
â”‚   2. Tropical Cheesecake from Island Breeze for $9.99.   â”‚
â”‚   Would you like to add one to your cart?"               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Tables**: `fc_menu_items`, `fc_menu_sections`, `fc_restaurants`
**Features**:
- Multi-word search (handles "New York cheesecake")
- Ranking by relevance
- Auto-image fetching from Pexels

---

## Action 3: Add Item to Cart (Voice)

```
User says: "Add the New York cheesecake to my cart"
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STT â†’ LLM â†’ Tool Selection                              â”‚
â”‚                                                          â”‚
â”‚  Tool: quick_add_to_cart                                 â”‚
â”‚  Params: {                                               â”‚
â”‚      item_name: "New York cheesecake",                   â”‚
â”‚      quantity: "1"  # inferred from context              â”‚
â”‚  }                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tool Execution: quick_add_to_cart_tool()                â”‚
â”‚                                                          â”‚
â”‚  1. Parse quantity: int("1") = 1                         â”‚
â”‚  2. Call database layer:                                 â”‚
â”‚     result = add_to_voice_cart(                          â”‚
â”‚         item_name="New York cheesecake",                 â”‚
â”‚         quantity=1                                       â”‚
â”‚     )                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Database Operations (database.py)                       â”‚
â”‚                                                          â”‚
â”‚  def add_to_voice_cart(item_name, quantity):             â”‚
â”‚      global voice_cart  # In-memory cart                 â”‚
â”‚                                                          â”‚
â”‚      # Step 1: Search for item in database               â”‚
â”‚      response = supabase                                 â”‚
â”‚          .table("fc_menu_items")                         â”‚
â”‚          .select("""                                     â”‚
â”‚              id, slug, name, base_price,                 â”‚
â”‚              restaurant:restaurant_id(                   â”‚
â”‚                  id, slug, name, delivery_fee            â”‚
â”‚              )                                           â”‚
â”‚          """)                                            â”‚
â”‚          .ilike("name", f"%{item_name}%")                â”‚
â”‚          .eq("is_available", True)                       â”‚
â”‚          .limit(1)                                       â”‚
â”‚          .execute()                                      â”‚
â”‚                                                          â”‚
â”‚      if not response.data:                               â”‚
â”‚          return {                                        â”‚
â”‚              "success": False,                           â”‚
â”‚              "message": "Item not found"                 â”‚
â”‚          }                                               â”‚
â”‚                                                          â”‚
â”‚      item = response.data[0]                             â”‚
â”‚      restaurant = item["restaurant"]                     â”‚
â”‚                                                          â”‚
â”‚      # Step 2: Initialize cart if doesn't exist          â”‚
â”‚      if voice_cart is None:                              â”‚
â”‚          voice_cart = {                                  â”‚
â”‚              "restaurantId": restaurant["id"],           â”‚
â”‚              "restaurantSlug": restaurant["slug"],       â”‚
â”‚              "restaurantName": restaurant["name"],       â”‚
â”‚              "items": [],                                â”‚
â”‚              "subtotal": 0,                              â”‚
â”‚              "deliveryFee": restaurant["delivery_fee"]   â”‚
â”‚                             or 2.99,                     â”‚
â”‚              "total": 0                                  â”‚
â”‚          }                                               â”‚
â”‚                                                          â”‚
â”‚      # Step 3: Check if item already in cart             â”‚
â”‚      existing_item = None                                â”‚
â”‚      for cart_item in voice_cart["items"]:               â”‚
â”‚          if cart_item["name"].lower() ==                 â”‚
â”‚             item["name"].lower():                        â”‚
â”‚              existing_item = cart_item                   â”‚
â”‚              break                                       â”‚
â”‚                                                          â”‚
â”‚      if existing_item:                                   â”‚
â”‚          # Update quantity                               â”‚
â”‚          existing_item["quantity"] += quantity           â”‚
â”‚          existing_item["totalPrice"] = (                 â”‚
â”‚              existing_item["basePrice"] *                â”‚
â”‚              existing_item["quantity"]                   â”‚
â”‚          )                                               â”‚
â”‚      else:                                               â”‚
â”‚          # Add new item                                  â”‚
â”‚          voice_cart["items"].append({                    â”‚
â”‚              "id": item["id"],                           â”‚
â”‚              "slug": item["slug"],                       â”‚
â”‚              "name": item["name"],                       â”‚
â”‚              "quantity": quantity,                       â”‚
â”‚              "basePrice": item["base_price"],            â”‚
â”‚              "totalPrice": item["base_price"] * quantity â”‚
â”‚          })                                              â”‚
â”‚                                                          â”‚
â”‚      # Step 4: Recalculate totals                        â”‚
â”‚      voice_cart["subtotal"] = sum(                       â”‚
â”‚          item["totalPrice"]                              â”‚
â”‚          for item in voice_cart["items"]                 â”‚
â”‚      )                                                   â”‚
â”‚      voice_cart["total"] = (                             â”‚
â”‚          voice_cart["subtotal"] +                        â”‚
â”‚          voice_cart["deliveryFee"]                       â”‚
â”‚      )                                                   â”‚
â”‚                                                          â”‚
â”‚      return {                                            â”‚
â”‚          "success": True,                                â”‚
â”‚          "message": f"Added {quantity} {item['name']}",  â”‚
â”‚          "cart": voice_cart,                             â”‚
â”‚          "subtotal": voice_cart["subtotal"],             â”‚
â”‚          "total": voice_cart["total"]                    â”‚
â”‚      }                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Data Channel: Send cart to frontend                     â”‚
â”‚                                                          â”‚
â”‚  {                                                       â”‚
â”‚      "type": "tool_call",                                â”‚
â”‚      "tool_name": "quick_add_to_cart",                   â”‚
â”‚      "result": {                                         â”‚
â”‚          "success": true,                                â”‚
â”‚          "cart": {                                       â”‚
â”‚              "items": [...],                             â”‚
â”‚              "subtotal": 8.99,                           â”‚
â”‚              "deliveryFee": 2.99,                        â”‚
â”‚              "total": 11.98                              â”‚
â”‚          }                                               â”‚
â”‚      }                                                   â”‚
â”‚  }                                                       â”‚
â”‚                                                          â”‚
â”‚  Frontend updates cart display                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Voice Response                                          â”‚
â”‚                                                          â”‚
â”‚  "I added New York cheesecake to your cart for $8.99.    â”‚
â”‚   Your current total is $11.98 including delivery."      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Features**:
- **In-memory cart**: `voice_cart` global variable
- **Cart initialization**: Created on first item
- **Restaurant locking**: All items must be from same restaurant
- **Quantity updates**: Increments if item already in cart
- **Real-time totals**: Auto-calculates subtotal + delivery

---

## Action 4: View Cart (Voice)

```
User says: "What's in my cart?"
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tool: quick_view_cart (no parameters)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Database Layer (database.py)                            â”‚
â”‚                                                          â”‚
â”‚  def get_voice_cart():                                   â”‚
â”‚      global voice_cart                                   â”‚
â”‚                                                          â”‚
â”‚      if not voice_cart or not voice_cart.get("items"):   â”‚
â”‚          return {                                        â”‚
â”‚              "success": False,                           â”‚
â”‚              "message": "Your cart is empty"             â”‚
â”‚          }                                               â”‚
â”‚                                                          â”‚
â”‚      return {                                            â”‚
â”‚          "success": True,                                â”‚
â”‚          "cart": voice_cart,                             â”‚
â”‚          "restaurant": {                                 â”‚
â”‚              "name": voice_cart["restaurantName"]        â”‚
â”‚          },                                              â”‚
â”‚          "items": voice_cart["items"],                   â”‚
â”‚          "subtotal": voice_cart["subtotal"],             â”‚
â”‚          "deliveryFee": voice_cart["deliveryFee"],       â”‚
â”‚          "total": voice_cart["total"],                   â”‚
â”‚          "itemCount": sum(                               â”‚
â”‚              item["quantity"]                            â”‚
â”‚              for item in voice_cart["items"]             â”‚
â”‚          )                                               â”‚
â”‚      }                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Voice Response                                          â”‚
â”‚                                                          â”‚
â”‚  "You have 1 item in your cart from Dessert Palace:      â”‚
â”‚   - New York Cheesecake x1 for $8.99.                    â”‚
â”‚   Your subtotal is $8.99, with $2.99 delivery,           â”‚
â”‚   your total is $11.98."                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Feature**: No database query needed - reads in-memory cart

---

## Action 5: Checkout (Voice)

```
User says: "Place my order"
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tool: quick_checkout (no parameters)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Database Layer (database.py)                            â”‚
â”‚                                                          â”‚
â”‚  def checkout_cart():                                    â”‚
â”‚      global voice_cart                                   â”‚
â”‚                                                          â”‚
â”‚      if not voice_cart or not voice_cart.get("items"):   â”‚
â”‚          return {                                        â”‚
â”‚              "success": False,                           â”‚
â”‚              "message": "Cart is empty"                  â”‚
â”‚          }                                               â”‚
â”‚                                                          â”‚
â”‚      # Generate order number                             â”‚
â”‚      import time                                         â”‚
â”‚      order_number = f"VO{str(int(time.time()))[-6:]}"   â”‚
â”‚      # Example: "VO123456"                               â”‚
â”‚                                                          â”‚
â”‚      # Create order summary                              â”‚
â”‚      order_summary = {                                   â”‚
â”‚          "orderNumber": order_number,                    â”‚
â”‚          "success": True,                                â”‚
â”‚          "restaurant": {                                 â”‚
â”‚              "id": voice_cart["restaurantId"],           â”‚
â”‚              "name": voice_cart["restaurantName"]        â”‚
â”‚          },                                              â”‚
â”‚          "items": voice_cart["items"],                   â”‚
â”‚          "subtotal": voice_cart["subtotal"],             â”‚
â”‚          "deliveryFee": voice_cart["deliveryFee"],       â”‚
â”‚          "total": voice_cart["total"],                   â”‚
â”‚          "itemCount": len(voice_cart["items"])           â”‚
â”‚      }                                                   â”‚
â”‚                                                          â”‚
â”‚      # Clear cart after checkout                         â”‚
â”‚      voice_cart = None                                   â”‚
â”‚                                                          â”‚
â”‚      return {                                            â”‚
â”‚          "success": True,                                â”‚
â”‚          "orderId": order_number,                        â”‚
â”‚          "restaurant": order_summary["restaurant"],      â”‚
â”‚          "itemCount": order_summary["itemCount"],        â”‚
â”‚          "total": order_summary["total"],                â”‚
â”‚          "orderDetails": order_summary                   â”‚
â”‚      }                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Data Channel: Send order confirmation to frontend       â”‚
â”‚                                                          â”‚
â”‚  {                                                       â”‚
â”‚      "type": "tool_call",                                â”‚
â”‚      "tool_name": "quick_checkout",                      â”‚
â”‚      "result": {                                         â”‚
â”‚          "success": true,                                â”‚
â”‚          "orderId": "VO123456",                          â”‚
â”‚          "total": 11.98,                                 â”‚
â”‚          "orderDetails": { ... }                         â”‚
â”‚      }                                                   â”‚
â”‚  }                                                       â”‚
â”‚                                                          â”‚
â”‚  Frontend displays order confirmation                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Voice Response                                          â”‚
â”‚                                                          â”‚
â”‚  "Perfect! Your order has been placed. Your order        â”‚
â”‚   number is VO123456. The total is $11.98 and your       â”‚
â”‚   food will arrive in about 30 minutes from Dessert      â”‚
â”‚   Palace. Is there anything else I can help you with?"   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Features**:
- **Order number generation**: `VO{timestamp}`
- **Cart clearing**: Resets for next order
- **No database persistence**: Demo mode (can be enhanced)

---

## Complete System Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      USER INTERFACE (Browser)                      â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                   â”‚
â”‚                                                                    â”‚
â”‚  /app/food/concierge-agentserver/page.tsx                          â”‚
â”‚  â€¢ LiveKitRoom component (@livekit/components-react)               â”‚
â”‚  â€¢ Microphone input (getUserMedia)                                 â”‚
â”‚  â€¢ Audio output (Web Audio API)                                    â”‚
â”‚  â€¢ Data channel listener (for tool results)                        â”‚
â”‚  â€¢ Real-time card rendering                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ 1. Request Token
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TOKEN ENDPOINT (Next.js API Route)                                â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                       â”‚
â”‚                                                                    â”‚
â”‚  /app/api/livekit-agentserver/token/route.ts                       â”‚
â”‚                                                                    â”‚
â”‚  1. RoomServiceClient.createRoom()                                 â”‚
â”‚     â””â”€â–º Creates room: "food-concierge-agentserver-{timestamp}"     â”‚
â”‚                                                                    â”‚
â”‚  2. AgentDispatchClient.createDispatch()                           â”‚
â”‚     â””â”€â–º Dispatches agent: "ubereats-food-concierge"                â”‚
â”‚                                                                    â”‚
â”‚  3. AccessToken.addGrant()                                         â”‚
â”‚     â””â”€â–º Permissions: join, publish, subscribe                      â”‚
â”‚                                                                    â”‚
â”‚  4. Returns: { token, url, roomName }                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ 2. Connect with Token
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LIVEKIT CLOUD INFRASTRUCTURE                                      â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                â”‚
â”‚                                                                    â”‚
â”‚  â€¢ WebRTC Media Server (wss://your-project.livekit.cloud)        â”‚
â”‚  â€¢ Room Management                                                 â”‚
â”‚  â€¢ Participant Tracking                                            â”‚
â”‚  â€¢ Agent Dispatch System                                           â”‚
â”‚  â€¢ Media Routing (audio/video/data)                                â”‚
â”‚                                                                    â”‚
â”‚  Room: "food-concierge-agentserver-123456"                         â”‚
â”‚  Participants:                                                     â”‚
â”‚    - user-5678 (human)                                             â”‚
â”‚    - ubereats-food-concierge (agent)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ 3. Agent Joins Room
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PYTHON AGENT (AgentServer Pattern)                                â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                              â”‚
â”‚                                                                    â”‚
â”‚  /agents/food_concierge_agentserver.py                             â”‚
â”‚                                                                    â”‚
â”‚  @server.rtc_session(                                              â”‚
â”‚      agent_name="ubereats-food-concierge"                          â”‚
â”‚  )                                                                 â”‚
â”‚  async def food_concierge_agent(ctx: JobContext):                  â”‚
â”‚                                                                    â”‚
â”‚      # 1. Initialize user state                                    â”‚
â”‚      userdata = UserState()                                        â”‚
â”‚                                                                    â”‚
â”‚      # 2. Create agent session                                     â”‚
â”‚      session = AgentSession[UserState](                            â”‚
â”‚          userdata=userdata,                                        â”‚
â”‚          stt=inference.STT("deepgram/nova-3"),                     â”‚
â”‚          llm=inference.LLM("openai/gpt-4o-mini"),                  â”‚
â”‚          tts=openai.TTS(),                                         â”‚
â”‚          vad=silero.VAD.load(),                                    â”‚
â”‚          max_tool_steps=10                                         â”‚
â”‚      )                                                             â”‚
â”‚                                                                    â”‚
â”‚      # 3. Register event handlers                                  â”‚
â”‚      @session.on("user_speech_committed")                          â”‚
â”‚      def on_user_speech(transcript):                               â”‚
â”‚          log and publish to frontend                               â”‚
â”‚                                                                    â”‚
â”‚      @session.on("agent_speech_committed")                         â”‚
â”‚      def on_agent_speech(transcript):                              â”‚
â”‚          log and publish to frontend                               â”‚
â”‚                                                                    â”‚
â”‚      # 4. Start agent with tools                                   â”‚
â”‚      agent = FoodConciergeAgent(userdata=userdata)                 â”‚
â”‚      agent.tools = [                                               â”‚
â”‚          get_user_profile_tool,                                    â”‚
â”‚          find_food_item_tool,                                      â”‚
â”‚          find_restaurants_by_type_tool,                            â”‚
â”‚          get_restaurant_menu_tool,                                 â”‚
â”‚          fetch_menu_item_image_tool,                               â”‚
â”‚          quick_view_cart_tool,                                     â”‚
â”‚          quick_add_to_cart_tool,                                   â”‚
â”‚          remove_from_cart_tool,                                    â”‚
â”‚          update_cart_quantity_tool,                                â”‚
â”‚          quick_checkout_tool                                       â”‚
â”‚      ]                                                             â”‚
â”‚                                                                    â”‚
â”‚      await session.start(agent=agent, room=ctx.room)               â”‚
â”‚                                                                    â”‚
â”‚      # 5. Generate greeting                                        â”‚
â”‚      await session.generate_reply(                                 â”‚
â”‚          "Say: Hello, Emilio - what are you in the mood for?"      â”‚
â”‚      )                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â–º 4. Tool Execution Flow
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FUNCTION TOOL LAYER                                               â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                          â”‚
â”‚                                                                    â”‚
â”‚  Each tool follows this pattern:                                   â”‚
â”‚                                                                    â”‚
â”‚  @function_tool                                                    â”‚
â”‚  async def tool_name(                                              â”‚
â”‚      ctx: RunContext[UserState],                                   â”‚
â”‚      param: Annotated[Type, Field(description="...")]              â”‚
â”‚  ) -> str:                                                         â”‚
â”‚      """                                                           â”‚
â”‚      Tool description for LLM.                                     â”‚
â”‚      Examples of when to call this tool.                           â”‚
â”‚      """                                                           â”‚
â”‚      # 1. Log tool call                                            â”‚
â”‚      logger.info(f"ğŸ”§ Tool: {tool_name}({params})")               â”‚
â”‚                                                                    â”‚
â”‚      # 2. Call database layer                                      â”‚
â”‚      result = await database_function(params)                      â”‚
â”‚                                                                    â”‚
â”‚      # 3. Send data to frontend (if applicable)                    â”‚
â”‚      if ctx.userdata.local_participant:                            â”‚
â”‚          await ctx.userdata.local_participant.publish_data(        â”‚
â”‚              json.dumps({                                          â”‚
â”‚                  "type": "tool_call",                              â”‚
â”‚                  "tool_name": "...",                               â”‚
â”‚                  "result": result                                  â”‚
â”‚              }).encode(),                                          â”‚
â”‚              reliable=True                                         â”‚
â”‚          )                                                         â”‚
â”‚                                                                    â”‚
â”‚      # 4. Return text summary for voice                            â”‚
â”‚      return "Natural language summary of result..."                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DATABASE LAYER                                                    â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                                  â”‚
â”‚                                                                    â”‚
â”‚  /agents/database.py                                               â”‚
â”‚                                                                    â”‚
â”‚  Functions (mirror TypeScript tools):                              â”‚
â”‚                                                                    â”‚
â”‚  async def get_user_profile(profile_id):                           â”‚
â”‚      â†’ Query fc_preferences                                        â”‚
â”‚                                                                    â”‚
â”‚  async def search_menu_items(query, max_results):                  â”‚
â”‚      â†’ Query fc_menu_items with multi-word search                  â”‚
â”‚      â†’ Rank by relevance                                           â”‚
â”‚      â†’ Fetch images from Pexels if missing                         â”‚
â”‚                                                                    â”‚
â”‚  async def search_restaurants_by_cuisine(cuisine, max):            â”‚
â”‚      â†’ Query fc_restaurants                                        â”‚
â”‚      â†’ Search cuisine, cuisine_group, name                         â”‚
â”‚      â†’ Fetch images from Pexels if missing                         â”‚
â”‚                                                                    â”‚
â”‚  async def get_restaurant_menu(restaurant_slug):                   â”‚
â”‚      â†’ Query fc_menu_sections_with_items view                      â”‚
â”‚      â†’ Return structured menu data                                 â”‚
â”‚                                                                    â”‚
â”‚  def add_to_voice_cart(item_name, quantity):                       â”‚
â”‚      â†’ Search fc_menu_items for item                               â”‚
â”‚      â†’ Initialize or update global voice_cart                      â”‚
â”‚      â†’ Recalculate totals                                          â”‚
â”‚      â†’ Return cart summary                                         â”‚
â”‚                                                                    â”‚
â”‚  def get_voice_cart():                                             â”‚
â”‚      â†’ Return global voice_cart (in-memory)                        â”‚
â”‚                                                                    â”‚
â”‚  def remove_from_cart(item_name, quantity):                        â”‚
â”‚      â†’ Update global voice_cart                                    â”‚
â”‚      â†’ Recalculate totals                                          â”‚
â”‚                                                                    â”‚
â”‚  def update_cart_item_quantity(item_name, new_qty):                â”‚
â”‚      â†’ Update global voice_cart                                    â”‚
â”‚      â†’ Recalculate totals                                          â”‚
â”‚                                                                    â”‚
â”‚  def checkout_cart():                                              â”‚
â”‚      â†’ Generate order number (VO{timestamp})                       â”‚
â”‚      â†’ Create order summary                                        â”‚
â”‚      â†’ Clear global voice_cart                                     â”‚
â”‚      â†’ Return order details                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SUPABASE DATABASE                                                 â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                              â”‚
â”‚                                                                    â”‚
â”‚  Python Client: supabase-py                                        â”‚
â”‚  Connection: Same credentials as TypeScript                        â”‚
â”‚                                                                    â”‚
â”‚  Tables:                                                           â”‚
â”‚  â€¢ fc_restaurants                                                  â”‚
â”‚  â€¢ fc_menu_sections                                                â”‚
â”‚  â€¢ fc_menu_items                                                   â”‚
â”‚  â€¢ fc_preferences                                                  â”‚
â”‚  â€¢ fc_menu_sections_with_items (view)                              â”‚
â”‚                                                                    â”‚
â”‚  Note: Cart operations use in-memory storage (voice_cart)          â”‚
â”‚        No fc_carts or fc_orders tables for voice demo              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  EXTERNAL APIS                                                     â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                                   â”‚
â”‚                                                                    â”‚
â”‚  â€¢ OpenAI API (via LiveKit inference layer)                        â”‚
â”‚    - GPT-4o-mini for LLM                                           â”‚
â”‚    - Function calling for tools                                    â”‚
â”‚    - TTS for voice synthesis                                       â”‚
â”‚                                                                    â”‚
â”‚  â€¢ Deepgram API (via LiveKit inference layer)                      â”‚
â”‚    - Nova-3 model for STT                                          â”‚
â”‚    - Real-time transcription                                       â”‚
â”‚                                                                    â”‚
â”‚  â€¢ Pexels API (direct)                                             â”‚
â”‚    - Image search for food items                                   â”‚
â”‚    - Image search for restaurants                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## LiveKit AgentServer Key Concepts

### 1. AgentServer Pattern

```python
from livekit.agents import AgentServer

server = AgentServer()

@server.rtc_session(
    on_session_end=on_session_end,
    agent_name="ubereats-food-concierge"  # Unique identifier
)
async def food_concierge_agent(ctx: JobContext) -> None:
    """
    Main agent entry point.
    
    Called automatically when:
    - User connects to room
    - Agent is dispatched by name
    
    Context provides:
    - ctx.room: LiveKit room instance
    - ctx.room.local_participant: Agent's participant
    - ctx.room.remote_participants: User participants
    """
    # Setup agent session...
    await session.start(agent=agent, room=ctx.room)
```

**How it works:**
1. Agent runs as a server process: `python food_concierge_agentserver.py dev`
2. Registers with LiveKit Cloud
3. Listens for dispatch events
4. Auto-joins rooms when dispatched by name
5. Handles WebRTC media streams

### 2. Typed UserState

```python
from dataclasses import dataclass

@dataclass
class UserState:
    """Session-specific state for each user"""
    user_id: str | None = None
    cart_id: str | None = None
    profile: dict | None = None
    order_count: int = 0
    local_participant: any = None  # For data channel
```

**Purpose:**
- Maintain state across tool calls
- Access room/participant info
- Store user context
- Pass data between tools

### 3. AgentSession Configuration

```python
from livekit.agents import AgentSession, inference
from livekit.plugins import openai, silero

session = AgentSession[UserState](
    userdata=userdata,
    
    # Speech-to-Text
    stt=inference.STT(
        "deepgram/nova-3",  # Model identifier
        language="en"        # Language code
    ),
    
    # Language Model
    llm=inference.LLM("openai/gpt-4o-mini"),
    
    # Text-to-Speech (OpenAI plugin, not inference)
    tts=openai.TTS(),
    
    # Voice Activity Detection
    vad=silero.VAD.load(),
    
    # Safety: Maximum tool calls per turn
    max_tool_steps=10
)
```

**Inference Layer:**
- Unified API for STT/LLM across providers
- Handles model connections automatically
- Manages retries and errors
- Supports multiple providers (Deepgram, OpenAI, etc.)

### 4. Function Tools

```python
from livekit.agents import function_tool
from typing import Annotated
from pydantic import Field

@function_tool
async def my_tool(
    ctx: RunContext[UserState],
    param: Annotated[
        str,
        Field(description="Parameter description for LLM")
    ]
) -> str:
    """
    Tool description that LLM reads.
    
    Explain when to call this tool.
    Provide examples.
    """
    # Access user state
    user_id = ctx.userdata.user_id
    
    # Perform operation
    result = await database_operation(param)
    
    # Send data to frontend
    if ctx.userdata.local_participant:
        await ctx.userdata.local_participant.publish_data(
            json.dumps(result).encode(),
            reliable=True
        )
    
    # Return text for voice response
    return "Natural language summary"
```

**Key Points:**
- `@function_tool` decorator registers tool with agent
- `RunContext[UserState]` provides typed access to state
- `Annotated[Type, Field(...)]` adds descriptions for LLM
- Docstring describes tool purpose
- Must return string (for voice synthesis)
- Can send structured data via data channel

### 5. Event System

```python
@session.on("user_speech_committed")
def on_user_speech(transcript: str):
    """Called when STT finalizes user speech"""
    logger.info(f"User said: {transcript}")
    # Send to frontend for display

@session.on("agent_speech_committed")
def on_agent_speech(transcript: str):
    """Called when agent response is generated"""
    logger.info(f"Agent saying: {transcript}")
    # Send to frontend for display

@session.on("function_calls_collected")
def on_function_calls(calls: list):
    """Called when LLM decides to call tools"""
    for call in calls:
        logger.info(f"Tool: {call.function_call.name}")

@session.on("function_calls_finished")
def on_function_results(results: list):
    """Called when tools finish executing"""
    for result in results:
        logger.info(f"Result: {result.result[:200]}")
```

**Events provide visibility:**
- Track conversation flow
- Debug tool calls
- Send updates to frontend
- Log for analytics

---

## Data Flow: Voice Cart Management

### In-Memory Cart (voice_cart)

```python
# Global variable in database.py
voice_cart: Optional[Dict[str, Any]] = None

# Structure:
voice_cart = {
    "restaurantId": "uuid",
    "restaurantSlug": "dessert-palace",
    "restaurantName": "Dessert Palace",
    "items": [
        {
            "id": "item-uuid",
            "slug": "new-york-cheesecake",
            "name": "New York Cheesecake",
            "quantity": 2,
            "basePrice": 8.99,
            "totalPrice": 17.98
        }
    ],
    "subtotal": 17.98,
    "deliveryFee": 2.99,
    "total": 20.97
}
```

**Why in-memory?**
- Faster for voice interactions (no DB round-trips)
- Simpler state management
- Demo/prototype focused
- Can be enhanced to use fc_carts table

**Architecture:**
```
User: "Add cheesecake"
       â”‚
       â–¼
Tool: quick_add_to_cart_tool()
       â”‚
       â–¼
Database: add_to_voice_cart()
       â”‚
       â”œâ”€â–º Query fc_menu_items (find item)
       â”‚
       â”œâ”€â–º Update global voice_cart variable
       â”‚       â”œâ”€â–º Initialize if None
       â”‚       â”œâ”€â–º Add/update item
       â”‚       â””â”€â–º Recalculate totals
       â”‚
       â””â”€â–º Return cart summary
```

---

## Comparison: AI SDK vs LiveKit

### Feature Comparison

| Feature | AI SDK (Chat) | LiveKit (Voice) |
|---------|---------------|-----------------|
| **Input Format** | Text (JSON) | Audio (WebRTC) |
| **Output Format** | Text stream | Audio stream |
| **Language** | TypeScript | Python |
| **Runtime** | Node.js/Edge | Python process |
| **State Storage** | Message history | UserState + in-memory |
| **Tool Definition** | `tool()` function | `@function_tool` decorator |
| **Database** | Supabase (TypeScript) | Supabase (Python) |
| **Cart Storage** | fc_carts table | In-memory (voice_cart) |
| **Real-time** | HTTP streaming | WebRTC duplex |
| **Latency** | ~500ms-2s | ~300ms-1s (voice optimized) |
| **Complexity** | Medium | Higher (media handling) |

### Architecture Comparison

```
AI SDK FLOW:
User types â†’ HTTP POST â†’ AI SDK route â†’ OpenAI â†’
Tool execution â†’ Database â†’ OpenAI response â†’
Streaming text â†’ Frontend display

LIVEKIT FLOW:
User speaks â†’ WebRTC audio â†’ LiveKit Cloud â†’
Python Agent â†’ Deepgram STT â†’ OpenAI LLM â†’
Tool execution â†’ Database â†’ OpenAI TTS â†’
WebRTC audio â†’ Frontend plays
```

### When to Use Each

**AI SDK (Chat):**
- Text-based interfaces
- Complex multi-turn conversations
- Rich text formatting needed
- Lower latency requirements
- Easier debugging
- Better for complex workflows

**LiveKit (Voice):**
- Voice-first experiences
- Hands-free interactions
- Real-time conversations
- Natural language priority
- Accessibility (vision-impaired)
- Automotive/IoT applications

---

## Environment Configuration

### Required Environment Variables

```bash
# .env.local

# LiveKit Credentials
LIVEKIT_URL=wss://your-project.livekit.cloud
LIVEKIT_API_KEY=APIxxxxx
LIVEKIT_API_SECRET=xxxxxxxxxx

# OpenAI (for LLM and TTS)
OPENAI_API_KEY=sk-proj-xxxxxx

# Supabase
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_SERVICE_ROLE_KEY=xxxxx

# Demo Profile
DEMO_PROFILE_ID=00000000-0000-0000-0000-0000000000fc

# Optional: Pexels for images
PEXELS_API_KEY=xxxxx
```

### Python Requirements

```txt
# agents/requirements.txt

livekit-agents>=1.4.1
livekit-plugins-openai
livekit-plugins-deepgram
livekit-plugins-silero
supabase
python-dotenv
httpx
```

---

## Running the Agent

### Development Mode

```bash
# Terminal 1: Start Next.js frontend
npm run dev

# Terminal 2: Start Python agent
cd agents
python food_concierge_agentserver.py dev
```

### Agent Logs

```
âœ… Database client initialized
   Supabase URL: http://127.0.0.1:54321
   Demo Profile: 00000000-0000-0000-0000-0000000000fc
   Pexels API: âœ“ Configured

ğŸš€ Agent starting for room: food-concierge-agentserver-123456
ğŸ”„ Voice cart reset for new session
âœ… Agent connected, local participant stored
ğŸ™ï¸ Generating greeting...
âœ… Agent session started with greeting

ğŸ¤ USER SAID: 'Show me Thai restaurants'
ğŸ”§ TOOL CALLED: find_restaurants_by_type({"cuisine_type": "thai"})
ğŸ”§ Tool: find_restaurants_by_type(cuisine_type='thai')
   âœ… Found 3 restaurants
   ğŸ“¤ Sent 3 restaurants to frontend
âœ… TOOL RESULT: Found 3 Thai restaurants:...
ğŸ¤– AGENT SAYING: 'I found 3 great Thai restaurants for you...'
```

---

## Debugging Tips

### 1. Check Agent Connection

```bash
# Agent should show:
ğŸš€ Agent starting for room: food-concierge-agentserver-xxxxx
âœ… Agent connected, local participant stored
```

### 2. Monitor Tool Calls

```bash
# Look for:
ğŸ”§ TOOL CALLED: tool_name({"param": "value"})
   âœ… Success message
   ğŸ“¤ Sent data to frontend
```

### 3. Check Data Channel

```typescript
// Frontend: Listen for tool results
room.on('data-received', (payload) => {
  const data = JSON.parse(payload);
  if (data.type === 'tool_call') {
    console.log('Tool result:', data.tool_name, data.result);
  }
});
```

### 4. Verify Database Connection

```python
# database.py logs:
âœ… Database client initialized
   Supabase URL: https://xxx.supabase.co
```

### 5. Common Issues

| Issue | Cause | Solution |
|-------|-------|----------|
| Agent doesn't join | Wrong agent name | Check `agent_name` matches dispatch |
| No audio | Permissions | Allow microphone in browser |
| Tool not called | Poor description | Improve tool docstrings |
| Database error | Wrong credentials | Check .env.local |
| Cart not working | voice_cart None | Check reset_voice_cart() called |

---

## Performance Optimization

### 1. STT/TTS Selection

```python
# Faster STT:
stt=inference.STT("deepgram/nova-2")  # Slightly faster

# Better quality STT:
stt=inference.STT("deepgram/nova-3")  # More accurate

# Faster TTS:
tts=inference.TTS("elevenlabs/eleven_turbo_v2")

# Better quality TTS:
tts=openai.TTS(voice="alloy")  # Natural sounding
```

### 2. Tool Optimization

```python
# Limit results for voice
max_results = 3  # Don't overwhelm voice UX

# Parallel data fetching
import asyncio
results = await asyncio.gather(
    search_menu_items(query1),
    search_restaurants(query2)
)

# Cache frequent queries
from functools import lru_cache

@lru_cache(maxsize=100)
def get_restaurant_by_slug(slug):
    # Cache results
```

### 3. Database Optimization

```python
# Use indexes (in Supabase)
CREATE INDEX idx_menu_items_name_trgm 
ON fc_menu_items USING gin(name gin_trgm_ops);

# Limit queries
.limit(max_results)

# Select only needed fields
.select("id, name, base_price")  # Not SELECT *
```

---

## Summary

### LiveKit AgentServer Powers:
- âœ… Real-time voice conversations (WebRTC)
- âœ… Automatic STT/TTS pipeline
- âœ… Function tool execution
- âœ… Typed state management (UserState)
- âœ… Event system for visibility
- âœ… Data channel for structured results
- âœ… Python-based extensibility

### Key Services:
- **LiveKit Cloud**: WebRTC infrastructure, room management, agent dispatch
- **Deepgram Nova-3**: Speech-to-text (STT)
- **OpenAI GPT-4o-mini**: Language model (LLM) with function calling
- **OpenAI TTS**: Text-to-speech (natural voices)
- **Supabase**: Database for food data
- **Pexels**: Image search for food/restaurants

### The Voice Flow:
```
User Voice â†’ STT â†’ LLM â†’ Tool Selection â†’ 
Database Query â†’ LLM Response â†’ TTS â†’ User Hears
```

### Advantages:
- **Natural**: Voice-first experience
- **Fast**: ~500ms voice-to-response
- **Flexible**: Python extensibility
- **Integrated**: Data channel + audio
- **Scalable**: LiveKit Cloud handles media

---

## Next Steps

- Explore system prompt engineering for better responses
- Add conversation memory (store in UserState)
- Enhance cart with database persistence
- Add payment integration at checkout
- Implement order tracking
- Add multi-language support
- Optimize for mobile/automotive

**Files to Explore:**
- `/agents/food_concierge_agentserver.py` - Main agent
- `/agents/database.py` - Database layer
- `/app/api/livekit-agentserver/token/route.ts` - Token endpoint
- `/app/food/concierge-agentserver/page.tsx` - Frontend

---

## Resources

- [LiveKit Agents Documentation](https://docs.livekit.io/agents/)
- [LiveKit Python SDK](https://github.com/livekit/python-sdks)
- [AgentServer Pattern Examples](https://github.com/livekit/agents/tree/main/examples)
- [Supabase Python Client](https://supabase.com/docs/reference/python)
- [OpenAI Function Calling](https://platform.openai.com/docs/guides/function-calling)

